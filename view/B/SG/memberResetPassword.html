<!DOCTYPE html>
<html>
<head>
    <script src="../checkCountry.js"></script>
    <script src="../../header.js"></script>
    <title>Edit Profile</title>
</head>
<body>
    <script>
        var countryPrefix = localStorage.getItem('urlPrefix');
        var authToken = sessionStorage.getItem("token");
        var member = JSON.parse(sessionStorage.getItem("member"));

        async function submitForm() {
            var name = document.getElementById("name").value;
            var phone = document.getElementById("phone").value;
            var oldPassword = document.getElementById("oldPassword").value;
            var newPassword = document.getElementById("password").value;
            var repassword = document.getElementById("repassword").value;

            const isChangingPassword = oldPassword || newPassword || repassword;

            // If user is trying to change password, all password fields must be filled
            if (isChangingPassword) {
    if (!oldPassword || !newPassword || !repassword) {
        alert("To change password, all password fields must be filled. Blank values are not allowed.");
        return;
    }
    if (newPassword.length < 8) {
        alert("New password must be at least 8 characters.");
        return;
    }
    if (newPassword !== repassword) {
        alert("New passwords do not match.");
        return;
    }

    // ✅ Verify old password
    const verifyRes = await fetch('/api/verifyPassword', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + authToken
        },
        body: JSON.stringify({ id: member.id, password: oldPassword })
    });

    const verifyData = await verifyRes.json();
    if (!verifyData.success) {
        alert("Old password is incorrect.");
        return;
    }
}

            // ✅ Proceed to update profile
            const updateData = {
                id: member.id,
                name: name,
                phone: phone,
                password: isChangingPassword ? newPassword : null
            };

            const updateRes = await fetch('/api/updateMember', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: 'Bearer ' + authToken
                },
                body: JSON.stringify(updateData)
            });

            const result = await updateRes.json();
            if (result.success) {
                sessionStorage.setItem("member", JSON.stringify(result.member));
                alert("Profile updated successfully!");
                location.reload();
            } else {
                alert("Failed to update profile.");
            }
        }

        window.onload = function () {
            document.getElementById("name").value = member.name;
            document.getElementById("phone").value = member.phone;
        };
    </script>

    <div class="container">
        <h2>Edit Profile</h2>
        <form onsubmit="submitForm(); return false;">
            <div>
                <label>Name:</label>
                <input type="text" id="name" class="form-control" required />
            </div>
            <div>
                <label>Phone:</label>
                <input type="text" id="phone" class="form-control" required />
            </div>
            <hr />
            <h4>Change Password (optional)</h4>
            <div>
                <label>Old Password:</label>
                <input type="password" id="oldPassword" class="form-control" />
            </div>
            <div>
                <label>New Password:</label>
                <input type="password" id="password" class="form-control" />
            </div>
            <div>
                <label>Re-enter New Password:</label>
                <input type="password" id="repassword" class="form-control" />
            </div>
            <br />
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>

    <script src="../footer.js"></script>
</body>
</html>
